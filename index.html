<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–æ–∑–¥–∞–π –Ω–æ–≤–æ–≥–æ–¥–Ω—é—é –æ—Ç–∫—Ä—ã—Ç–∫—É</title>
    <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@700&family=Marck+Script&family=Bad+Script&display=swap" rel="stylesheet">
    <style>
        /* –°—Ç–∏–ª–∏ –æ—Å—Ç–∞–ª–∏—Å—å –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –ø—Ä–µ–∂–Ω–∏–º–∏, —Å –Ω–µ–±–æ–ª—å—à–∏–º–∏ –¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è–º–∏ –¥–ª—è –Ω–æ–≤—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Caveat', cursive;
            background: linear-gradient(135deg, #1a2a6c, #2c3e50);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            position: relative;
            overflow-x: hidden;
        }

        /* –°–Ω–µ–∂–∏–Ω–∫–∏ */
        .snowflakes {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        .snowflake {
            position: absolute;
            top: -10px;
            color: white;
            font-size: 1.5rem;
            opacity: 0.8;
            animation: fall linear infinite;
        }

        @keyframes fall {
            to {
                transform: translateY(100vh) rotate(360deg);
            }
        }

        .container {
            max-width: 1200px;
            width: 100%;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            margin: 20px 0;
        }

        h1 {
            text-align: center;
            color: #014d77;
            margin-bottom: 30px;
            font-size: 2.8em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
            font-weight: 700;
        }

        .creator-section {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .controls {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            border: 2px solid #e9ecef;
            max-height: 800px;
            overflow-y: auto;
        }

        .control-group {
            margin-bottom: 25px;
        }

        .control-group h3 {
            color: #014d77;
            margin-bottom: 15px;
            font-size: 1.4em;
            font-weight: 700;
        }

        .control-group h4 {
            color: #014d77;
            margin: 15px 0 8px 0;
            font-size: 1.1em;
            font-weight: 600;
        }

        .orientation-buttons {
            display: flex;
            gap: 8px;
        }

        .orientation-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid #dee2e6;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            font-size: 16px;
            font-family: 'Caveat', cursive;
            font-weight: 600;
        }

        .orientation-btn.active {
            border-color: #014d77;
            background: #f0f8ff;
            color: #014d77;
        }

        .backgrounds-grid, .stickers-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            max-height: 150px;
            overflow-y: auto;
            /* –£–±—Ä–∞–Ω–∞ –∏–Ω–ª–∞–π–Ω-–ø—Ä–æ–∫—Ä—É—Ç–∫–∞ —Å—Ç–∏–∫–µ—Ä–æ–≤ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è UX */
            max-height: none; 
            overflow-y: visible;
        }

        .background-item, .sticker-item {
            aspect-ratio: 1;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            cursor: pointer;
            background-size: cover;
            background-position: center;
            transition: all 0.3s;
        }

        .background-item.active, .sticker-item.active {
            border-color: #014d77;
            transform: scale(0.95);
        }

        .text-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 18px;
            resize: vertical;
            min-height: 80px;
            font-family: 'Caveat', cursive;
            font-weight: 500;
        }

        .font-buttons, .align-buttons, .size-buttons, .color-control {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            align-items: center;
        }
        
        .color-control input[type="color"] {
            width: 40px;
            height: 40px;
            padding: 2px;
            border: 2px solid #dee2e6;
            border-radius: 5px;
            cursor: pointer;
        }

        .font-btn, .align-btn, .size-btn {
            flex: 1;
            padding: 10px;
            background: rgba(1, 77, 119, 0.1);
            border-radius: 5px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            border: 1px solid #dee2e6;
            font-family: 'Caveat', cursive;
            font-weight: 600;
        }

        .font-btn.active, .align-btn.active, .size-btn.active {
            background: #014d77;
            color: white;
            border-color: #014d77;
        }

        .font-marck { font-family: 'Marck Script', cursive; }
        .font-caveat { font-family: 'Caveat', cursive; }
        .font-badscript { font-family: 'Bad Script', cursive; }

        .preview-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #e9ecef;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            min-height: 500px;
        }

        #cardCanvas {
            max-width: 100%;
            max-height: 500px;
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            background: white;
            /* –ö—É—Ä—Å–æ—Ä –º–µ–Ω—è–µ—Ç—Å—è JS –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞ */
            cursor: default; 
        }

        .actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: 'Caveat', cursive;
            font-weight: 700;
        }

        .btn-download { background: #014d77; color: white; }
        .btn-download:hover { background: #013a5c; transform: translateY(-2px); }

        .btn-clear { background: #6c757d; color: white; }
        .btn-clear:hover { background: #5a6268; transform: translateY(-2px); }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å - –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π */
        @media (max-width: 968px) {
            .creator-section { grid-template-columns: 1fr; gap: 20px; }
            .controls { order: 2; max-height: none; }
            .preview-section { order: 1; min-height: 400px; }
            h1 { font-size: 2.2em; }
        }

        @media (max-width: 480px) {
            .container { padding: 15px; }
            .controls { padding: 15px; }
            .orientation-buttons { flex-direction: column; }
        }
    </style>
</head>
<body onload="init()">
    <div class="snowflakes" id="snowflakes"></div>

    <div class="container">
        <h1>üéÑ –ù–æ–≤–æ–≥–æ–¥–Ω–∏–π –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –û—Ç–∫—Ä—ã—Ç–æ–∫ üéÖ</h1>
        
        <div class="creator-section">
            <div class="controls">
                <div class="control-group">
                    <h3>–§–æ—Ä–º–∞—Ç –æ—Ç–∫—Ä—ã—Ç–∫–∏</h3>
                    <div class="orientation-buttons">
                        <div class="orientation-btn active" data-orientation="vertical">üì± –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è</div>
                        <div class="orientation-btn" data-orientation="horizontal">üñ•Ô∏è –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è</div>
                    </div>
                </div>

                <div class="control-group">
                    <h3>–§–æ–Ω –æ—Ç–∫—Ä—ã—Ç–∫–∏</h3>
                    <div class="backgrounds-grid" id="backgroundsGrid">
                        </div>
                </div>

                <div class="control-group">
                    <h3>–¢–µ–∫—Å—Ç –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è</h3>
                    <textarea class="text-input" id="greetingText" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –Ω–æ–≤–æ–≥–æ–¥–Ω–µ–µ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ...">–° –ù–æ–≤—ã–º –ì–æ–¥–æ–º!</textarea>
                    
                    <h4>–®—Ä–∏—Ñ—Ç —Ç–µ–∫—Å—Ç–∞</h4>
                    <div class="font-buttons">
                        <div class="font-btn active font-marck" data-font="Marck Script">Marck Script</div>
                        <div class="font-btn font-caveat" data-font="Caveat">Caveat</div>
                        <div class="font-btn font-badscript" data-font="Bad Script">Bad Script</div>
                    </div>
                    
                    <h4>–†–∞–∑–º–µ—Ä –∏ —Ü–≤–µ—Ç</h4>
                    <div class="size-buttons">
                        <div class="size-btn" data-size="small">–ú–∞–ª–µ–Ω—å–∫–∏–π</div>
                        <div class="size-btn active" data-size="medium">–°—Ä–µ–¥–Ω–∏–π</div>
                        <div class="size-btn" data-size="large">–ë–æ–ª—å—à–æ–π</div>
                    </div>
                    <div class="color-control">
                        <label>–¶–≤–µ—Ç:</label>
                        <input type="color" id="textColor" value="#ffffff">
                    </div>
                    
                    <h4>–í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞</h4>
                    <div class="align-buttons">
                        <div class="align-btn active" data-align="center">–ü–æ —Ü–µ–Ω—Ç—Ä—É</div>
                        <div class="align-btn" data-align="left">–°–ª–µ–≤–∞</div>
                        <div class="align-btn" data-align="right">–°–ø—Ä–∞–≤–∞</div>
                    </div>
                </div>

                <div class="control-group">
                    <h3>–ù–æ–≤–æ–≥–æ–¥–Ω–∏–µ —Å—Ç–∏–∫–µ—Ä—ã</h3>
                    <div class="stickers-grid" id="stickersGrid">
                        </div>
                    <p style="color: #014d77; font-size: 16px; margin-top: 8px; font-family: 'Caveat', cursive; font-weight: 500;">
                        –ù–∞–∂–º–∏—Ç–µ –Ω–∞ —Å—Ç–∏–∫–µ—Ä, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å. –ü–µ—Ä–µ–º–µ—â–∞–π—Ç–µ –∏ –∏–∑–º–µ–Ω—è–π—Ç–µ —Ä–∞–∑–º–µ—Ä –Ω–∞ –æ—Ç–∫—Ä—ã—Ç–∫–µ. –í—ã–±–µ—Ä–∏—Ç–µ —ç–ª–µ–º–µ–Ω—Ç, —á—Ç–æ–±—ã **—É–¥–∞–ª–∏—Ç—å (–∫–ª–∞–≤–∏—à–∞ Delete/Backspace)**.
                    </p>
                </div>
            </div>

            <div class="preview-section">
                <canvas id="cardCanvas"></canvas>
            </div>
        </div>

        <div class="actions">
            <button class="btn btn-download" onclick="downloadCard()">
                üíæ –°–∫–∞—á–∞—Ç—å –æ—Ç–∫—Ä—ã—Ç–∫—É (HD)
            </button>
            <button class="btn btn-clear" onclick="clearCard()">
                üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å
            </button>
        </div>
    </div>

    <script>
        // –ò–ù–ñ–ï–ù–ï–†–ò–Ø:
        // 1. –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ—Å—É—Ä—Å–æ–≤ —Ä–µ—à–µ–Ω–∞ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º –≤ preloadAssets().
        // 2. –¢–µ–∫—Å—Ç, –õ–æ–≥–æ –∏ –°—Ç–∏–∫–µ—Ä—ã —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω—ã –≤ state.draggableItems.
        // 3. –î–æ–±–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∏ –≤—ã–¥–µ–ª–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤.

        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è - —Ñ–∞–π–ª—ã –≤ –∫–æ—Ä–Ω–µ —Å–µ—Ä–≤–µ—Ä–∞
        const config = {
            orientations: {
                vertical: { width: 400, height: 600 },
                horizontal: { width: 600, height: 400 }
            },
            backgrounds: [
                'bg1.png', 'bg2.png', 'bg3.png', 'bg4.png',
                'bg5.png', 'bg6.png', 'bg7.png', 'bg8.png'
            ],
            stickers: [
                'sticker1.png', 'sticker2.png', 'sticker3.png', 'sticker4.png',
                'sticker5.png', 'sticker6.png', 'sticker7.png', 'sticker8.png'
            ],
            logo: 'logo3.png'
        };

        // –ö–≠–® –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ô: –ó–¥–µ—Å—å –±—É–¥—É—Ç —Ö—Ä–∞–Ω–∏—Ç—å—Å—è –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ Image-–æ–±—ä–µ–∫—Ç—ã
        let cachedImages = new Map();
        let backgroundItem = null;
        let logoItem = null;

        // –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        let state = {
            orientation: 'vertical',
            selectedBackground: config.backgrounds[0],
            // –í—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ –¥–≤–∏–≥–∞—Ç—å/–º–µ–Ω—è—Ç—å, –≤–∫–ª—é—á–∞—è —Ç–µ–∫—Å—Ç –∏ –ª–æ–≥–æ—Ç–∏–ø
            draggableItems: [],
            greetingText: '–° –ù–æ–≤—ã–º –ì–æ–¥–æ–º!',
            textFont: 'Marck Script',
            textSize: 'medium',
            textAlign: 'center',
            textColor: '#ffffff',
            
        };

        // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
        const canvas = document.getElementById('cardCanvas');
        const ctx = canvas.getContext('2d');
        const backgroundsGrid = document.getElementById('backgroundsGrid');
        const stickersGrid = document.getElementById('stickersGrid');
        const greetingTextInput = document.getElementById('greetingText');
        const textColorInput = document.getElementById('textColor');
        const snowflakesContainer = document.getElementById('snowflakes');
        const fontBtns = document.querySelectorAll('.font-btn');
        const alignBtns = document.querySelectorAll('.align-btn');
        const sizeBtns = document.querySelectorAll('.size-btn');

        // –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ–º—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
        let selectedElementIndex = -1; // –ò–Ω–¥–µ–∫—Å –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ –≤ draggableItems
        let isDragging = false;
        let isResizing = false;
        let dragStartX, dragStartY;
        let elementStartX, elementStartY;
        let elementStartWidth, elementStartHeight;

        // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ò –ó–ê–ì–†–£–ó–ö–ê ---

        async function preloadAssets() {
            const allAssets = [...config.backgrounds, ...config.stickers, config.logo];
            const promises = allAssets.map(src => {
                return new Promise((resolve) => {
                    if (cachedImages.has(src)) {
                        resolve();
                        return;
                    }
                    const img = new Image();
                    img.onload = () => {
                        cachedImages.set(src, img);
                        resolve();
                    };
                    img.onerror = () => {
                        console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–µ—Å—É—Ä—Å:', src);
                        resolve(); // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º, –¥–∞–∂–µ –µ—Å–ª–∏ –æ–¥–∏–Ω —Ä–µ—Å—É—Ä—Å –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è
                    };
                    img.src = src;
                });
            });
            return Promise.all(promises);
        }

        async function init() {
            await preloadAssets();
            createSnowflakes();
            setupCanvas();
            loadInitialElements();
            loadBackgrounds();
            loadStickers();
            setupEventListeners();
            renderCard();
        }

        function loadInitialElements() {
             // 1. –°–æ–∑–¥–∞–µ–º –õ–æ–≥–æ—Ç–∏–ø
            const logoImg = cachedImages.get(config.logo);
            if (logoImg) {
                const logoSize = Math.min(config.orientations.vertical.width, config.orientations.vertical.height) * 0.36;
                const ratio = logoImg.width / logoImg.height;
                const width = logoSize;
                const height = logoSize / ratio;

                logoItem = {
                    type: 'logo',
                    src: config.logo,
                    x: config.orientations.vertical.width - width - 20,
                    y: 20,
                    width: width,
                    height: height,
                    fixedAspect: true // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏
                };
                state.draggableItems.push(logoItem);
            }

            // 2. –°–æ–∑–¥–∞–µ–º –¢–µ–∫—Å—Ç–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç
            const textItem = {
                type: 'text',
                x: config.orientations.vertical.width / 2, // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–ª—è —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è
                y: config.orientations.vertical.height * 0.4,
                width: config.orientations.vertical.width * 0.8, // –®–∏—Ä–∏–Ω–∞ –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞
                height: 0, // –í—ã—Å–æ—Ç–∞ –±—É–¥–µ—Ç —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–∞ –≤ renderText
                content: state.greetingText,
                font: state.textFont,
                size: state.textSize,
                align: state.textAlign,
                color: state.textColor,
                fixedAspect: false
            };
            state.draggableItems.push(textItem);
        }
        
        // ... (–û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ JavaScript) ...

        function createSnowflakes() {
            const snowflakeCount = 50;
            for (let i = 0; i < snowflakeCount; i++) {
                const snowflake = document.createElement('div');
                snowflake.classList.add('snowflake');
                snowflake.innerHTML = '‚ùÑ';
                snowflake.style.left = Math.random() * 100 + 'vw';
                snowflake.style.animationDuration = (Math.random() * 10 + 5) + 's';
                snowflake.style.animationDelay = Math.random() * 5 + 's';
                snowflake.style.opacity = Math.random() * 0.7 + 0.3;
                snowflake.style.fontSize = (Math.random() * 10 + 10) + 'px';
                snowflakesContainer.appendChild(snowflake);
            }
        }

        function setupCanvas() {
            const { width, height } = config.orientations[state.orientation];
            canvas.width = width;
            canvas.height = height;
            canvas.style.width = `${width}px`;
            canvas.style.height = `${height}px`;

            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –ø—Ä–∏ —Å–º–µ–Ω–µ –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏, —á—Ç–æ–±—ã –æ–Ω–∏ –æ—Å—Ç–∞–≤–∞–ª–∏—Å—å –≤ —Ü–µ–Ω—Ç—Ä–µ
            state.draggableItems.forEach(item => {
                if (item.type === 'text') {
                     item.x = width / 2;
                     item.y = height * 0.4;
                     item.width = width * 0.8;
                } else if (item.type === 'logo') {
                    const ratio = cachedImages.get(item.src).width / cachedImages.get(item.src).height;
                    const logoSize = Math.min(width, height) * 0.36;
                    item.width = logoSize;
                    item.height = logoSize / ratio;
                    item.x = width - item.width - 20;
                    item.y = 20;
                } else if (item.type === 'sticker') {
                    // –ü—Ä–æ—Å—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ–±—ã —Å—Ç–∏–∫–µ—Ä—ã –Ω–µ –≤—ã—à–ª–∏ –∑–∞ –Ω–æ–≤—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã
                    item.x = Math.min(item.x, width - item.width);
                    item.y = Math.min(item.y, height - item.height);
                }
            });
        }

        function loadBackgrounds() {
            backgroundsGrid.innerHTML = '';
            config.backgrounds.forEach((bg) => {
                const bgItem = document.createElement('div');
                bgItem.className = 'background-item';
                bgItem.style.backgroundImage = `url(${bg})`;
                bgItem.dataset.background = bg;
                bgItem.addEventListener('click', () => selectBackground(bg));
                backgroundsGrid.appendChild(bgItem);

                if (bg === state.selectedBackground) {
                    bgItem.classList.add('active');
                }
            });
        }

        function loadStickers() {
            stickersGrid.innerHTML = '';
            config.stickers.forEach((sticker) => {
                const stickerItem = document.createElement('div');
                stickerItem.className = 'sticker-item';
                stickerItem.style.backgroundImage = `url(${sticker})`;
                stickerItem.dataset.sticker = sticker;
                stickerItem.addEventListener('click', () => addSticker(sticker));
                stickersGrid.appendChild(stickerItem);
            });
        }

        function setupEventListeners() {
            // –û—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è
            document.querySelectorAll('.orientation-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.orientation-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    state.orientation = e.target.dataset.orientation;
                    setupCanvas();
                    renderCard();
                });
            });

            // –¢–µ–∫—Å—Ç
            greetingTextInput.addEventListener('input', (e) => {
                state.greetingText = e.target.value;
                const textItem = state.draggableItems.find(item => item.type === 'text');
                if (textItem) textItem.content = state.greetingText;
                renderCard();
            });

            // –¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞
            textColorInput.addEventListener('input', (e) => {
                state.textColor = e.target.value;
                const textItem = state.draggableItems.find(item => item.type === 'text');
                if (textItem) textItem.color = state.textColor;
                renderCard();
            });

            // –®—Ä–∏—Ñ—Ç—ã, –†–∞–∑–º–µ—Ä, –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ
            [...fontBtns, ...sizeBtns, ...alignBtns].forEach(btn => {
                btn.addEventListener('click', function() {
                    const group = this.parentNode.className.split('-')[0];
                    const datasetKey = group === 'font' ? 'font' : group === 'size' ? 'size' : 'align';
                    
                    document.querySelectorAll(`.${group}-btn`).forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    state[`text${datasetKey.charAt(0).toUpperCase() + datasetKey.slice(1)}`] = this.dataset[datasetKey];

                    const textItem = state.draggableItems.find(item => item.type === 'text');
                    if (textItem) {
                         textItem[datasetKey] = this.dataset[datasetKey];
                    }
                    renderCard();
                });
            });

            // –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –Ω–∞ canvas
            canvas.addEventListener('mousedown', startDrag);
            document.addEventListener('mousemove', drag); // Dragging outside canvas for better UX
            document.addEventListener('mouseup', stopDrag);
            
            canvas.addEventListener('touchstart', startDragTouch);
            document.addEventListener('touchmove', dragTouch, { passive: false });
            document.addEventListener('touchend', stopDrag);

            // –£–¥–∞–ª–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ (Delete/Backspace)
            document.addEventListener('keydown', (e) => {
                if (selectedElementIndex !== -1 && (e.key === 'Delete' || e.key === 'Backspace')) {
                    if (state.draggableItems[selectedElementIndex].type === 'sticker') {
                        state.draggableItems.splice(selectedElementIndex, 1);
                        selectedElementIndex = -1;
                        renderCard();
                    }
                }
            });
        }

        function selectBackground(background) {
            document.querySelectorAll('.background-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.background === background) {
                    item.classList.add('active');
                }
            });
            state.selectedBackground = background;
            renderCard();
        }

        function addSticker(sticker) {
            const img = cachedImages.get(sticker);
            if (!img) return;

            const size = Math.min(canvas.width, canvas.height) * 0.15;
            const aspectRatio = img.width / img.height;
            let width, height;

            if (aspectRatio > 1) {
                width = size;
                height = size / aspectRatio;
            } else {
                height = size;
                width = size * aspectRatio;
            }

            const newSticker = {
                type: 'sticker',
                src: sticker,
                x: canvas.width / 2 - width / 2 + Math.random() * 20 - 10, // –°–¥–≤–∏–≥ –¥–ª—è –≤–∏–¥–∏–º–æ—Å—Ç–∏
                y: canvas.height / 2 - height / 2 + Math.random() * 20 - 10,
                width: width,
                height: height,
                fixedAspect: true
            };

            state.draggableItems.push(newSticker);
            selectedElementIndex = state.draggableItems.length - 1; // –í—ã–±–∏—Ä–∞–µ–º —Ç–æ–ª—å–∫–æ —á—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–π
            renderCard();
        }

        // --- –õ–û–ì–ò–ö–ê –ü–ï–†–ï–¢–ê–°–ö–ò–í–ê–ù–ò–Ø ---

        function getCanvasMousePosition(e) {
            const rect = canvas.getBoundingClientRect();
            return {
                x: (e.clientX - rect.left) * (canvas.width / rect.width),
                y: (e.clientY - rect.top) * (canvas.height / rect.height)
            };
        }
        
        function getCanvasTouchPosition(e) {
            const touch = e.touches[0];
            const rect = canvas.getBoundingClientRect();
            return {
                x: (touch.clientX - rect.left) * (canvas.width / rect.width),
                y: (touch.clientY - rect.top) * (canvas.height / rect.height)
            };
        }

        function getElementAt(x, y) {
            // –ò—â–µ–º —Å –∫–æ–Ω—Ü–∞, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å –≤–µ—Ä—Ö–Ω–∏–π —ç–ª–µ–º–µ–Ω—Ç
            for (let i = state.draggableItems.length - 1; i >= 0; i--) {
                const item = state.draggableItems[i];
                if (item.type === 'text') {
                    // –î–ª—è —Ç–µ–∫—Å—Ç–∞ –Ω—É–∂–Ω–æ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ–±–ª–∞—Å—Ç–∏ (–ø—Ä–æ—Å—Ç–æ –¥–ª—è –∫–ª–∏–∫–∞)
                    const textBoundaryX = item.align === 'center' ? item.x - item.width / 2 : item.x;
                    const textBoundaryWidth = item.width;
                    const textBoundaryHeight = item.height; // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—É—é –≤—ã—Å–æ—Ç—É

                    if (x >= textBoundaryX && x <= textBoundaryX + textBoundaryWidth &&
                        y >= item.y - item.height / 2 && y <= item.y + item.height / 2) {
                        return i;
                    }
                } else if (item.type === 'sticker' || item.type === 'logo') {
                    if (x >= item.x && x <= item.x + item.width &&
                        y >= item.y && y <= item.y + item.height) {
                        return i;
                    }
                }
            }
            return -1;
        }

        function startDrag(e) {
            const { x, y } = getCanvasMousePosition(e);
            
            const index = getElementAt(x, y);
            if (index === -1) {
                selectedElementIndex = -1; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä, –µ—Å–ª–∏ –∫–ª–∏–∫ –≤–Ω–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                renderCard();
                return;
            }

            const selectedElement = state.draggableItems[index];

            // –ü–µ—Ä–µ–º–µ—â–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –Ω–∞ —Å–∞–º—ã–π –≤–µ—Ä—Ö –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
            if (index !== state.draggableItems.length - 1) {
                state.draggableItems.splice(index, 1);
                state.draggableItems.push(selectedElement);
                selectedElementIndex = state.draggableItems.length - 1;
            } else {
                selectedElementIndex = index;
            }
            

            dragStartX = x;
            dragStartY = y;
            elementStartX = selectedElement.x;
            elementStartY = selectedElement.y;
            elementStartWidth = selectedElement.width;
            elementStartHeight = selectedElement.height;

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–ª–∏–∫ –ø–æ —É–≥–ª—É –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è —Å—Ç–∏–∫–µ—Ä–æ–≤/–ª–æ–≥–æ)
            const cornerSize = 30; // –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π —Ä–∞–∑–º–µ—Ä –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
            if ((selectedElement.type === 'sticker' || selectedElement.type === 'logo') &&
                x > selectedElement.x + selectedElement.width - cornerSize &&
                y > selectedElement.y + selectedElement.height - cornerSize) {
                isResizing = true;
                isDragging = false;
                canvas.style.cursor = 'nwse-resize';
            } else {
                isDragging = true;
                isResizing = false;
                canvas.style.cursor = 'move';
            }
            
            e.preventDefault();
            renderCard(); // –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Ä–∞–º–∫—É –≤—ã–±–æ—Ä–∞
        }

        function startDragTouch(e) {
             const { x, y } = getCanvasTouchPosition(e);
            
            const index = getElementAt(x, y);
            if (index === -1) {
                selectedElementIndex = -1; 
                renderCard();
                return;
            }

            const selectedElement = state.draggableItems[index];

            // –ü–µ—Ä–µ–º–µ—â–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –Ω–∞ —Å–∞–º—ã–π –≤–µ—Ä—Ö
            if (index !== state.draggableItems.length - 1) {
                state.draggableItems.splice(index, 1);
                state.draggableItems.push(selectedElement);
                selectedElementIndex = state.draggableItems.length - 1;
            } else {
                selectedElementIndex = index;
            }

            dragStartX = x;
            dragStartY = y;
            elementStartX = selectedElement.x;
            elementStartY = selectedElement.y;
            elementStartWidth = selectedElement.width;
            elementStartHeight = selectedElement.height;

            const cornerSize = 50; // –ë–æ–ª—å—à–µ –¥–ª—è —Ç–∞—á—Å–∫—Ä–∏–Ω–æ–≤
            if ((selectedElement.type === 'sticker' || selectedElement.type === 'logo') &&
                x > selectedElement.x + selectedElement.width - cornerSize &&
                y > selectedElement.y + selectedElement.height - cornerSize) {
                isResizing = true;
                isDragging = false;
            } else {
                isDragging = true;
                isResizing = false;
            }
            
            e.preventDefault();
            renderCard();
        }

        function drag(e) {
            if (selectedElementIndex === -1 || (!isDragging && !isResizing)) return;
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º clientX/Y –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –≤–Ω–µ canvas, –∑–∞—Ç–µ–º –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã canvas
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;

            const x = (e.clientX - rect.left) * scaleX;
            const y = (e.clientY - rect.top) * scaleY;

            const selectedElement = state.draggableItems[selectedElementIndex];

            if (isResizing) {
                const newWidth = Math.max(40, elementStartWidth + (x - dragStartX));
                
                if (selectedElement.fixedAspect) {
                     // –î–ª—è —Å—Ç–∏–∫–µ—Ä–æ–≤ –∏ –ª–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏
                     const img = cachedImages.get(selectedElement.src);
                     const aspectRatio = img.width / img.height;
                     selectedElement.width = newWidth;
                     selectedElement.height = newWidth / aspectRatio;
                } else {
                    // –î–ª—è —Ç–µ–∫—Å—Ç–∞ –º–µ–Ω—è–µ–º —Ç–æ–ª—å–∫–æ —à–∏—Ä–∏–Ω—É –æ–±–ª–∞—Å—Ç–∏ –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞ (height —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è)
                    selectedElement.width = Math.min(canvas.width * 0.9, newWidth);
                }
            } else if (isDragging) {
                const deltaX = x - dragStartX;
                const deltaY = y - dragStartY;

                let newX = elementStartX + deltaX;
                let newY = elementStartY + deltaY;

                // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö canvas
                if (selectedElement.type === 'sticker' || selectedElement.type === 'logo') {
                    newX = Math.max(0, Math.min(canvas.width - selectedElement.width, newX));
                    newY = Math.max(0, Math.min(canvas.height - selectedElement.height, newY));
                    selectedElement.x = newX;
                    selectedElement.y = newY;
                } else if (selectedElement.type === 'text') {
                    // –î–ª—è —Ç–µ–∫—Å—Ç–∞ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—É—é —Ç–æ—á–∫—É, —á—Ç–æ–±—ã —Ç–µ–∫—Å—Ç –±—ã–ª –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö
                    selectedElement.x = Math.max(selectedElement.width/2, Math.min(canvas.width - selectedElement.width/2, newX));
                    selectedElement.y = Math.max(selectedElement.height/2, Math.min(canvas.height - selectedElement.height/2, newY));
                }
            }

            renderCard();
        }

        function dragTouch(e) {
            if (selectedElementIndex === -1 || (!isDragging && !isResizing) || !e.touches || e.touches.length !== 1) return;
            
            const touch = e.touches[0];
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;

            const x = (touch.clientX - rect.left) * scaleX;
            const y = (touch.clientY - rect.top) * scaleY;
            
            drag({ clientX: touch.clientX, clientY: touch.clientY, preventDefault: e.preventDefault.bind(e) });
            e.preventDefault();
        }

        function stopDrag() {
            isDragging = false;
            isResizing = false;
            canvas.style.cursor = 'default';
        }


        // --- –û–¢–†–ò–°–û–í–ö–ê ---

        function renderCard() {
            // –û—á–∏—â–∞–µ–º —Ö–æ–ª—Å—Ç
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // 1. –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –§–æ–Ω–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ)
            if (state.selectedBackground) {
                const bgImg = cachedImages.get(state.selectedBackground);
                if (bgImg) {
                    const imgRatio = bgImg.width / bgImg.height;
                    const canvasRatio = canvas.width / canvas.height;
                    
                    let drawWidth, drawHeight, offsetX, offsetY;
                    
                    if (imgRatio > canvasRatio) { // –ó–∞–ø–æ–ª–Ω–∏—Ç—å –ø–æ –≤—ã—Å–æ—Ç–µ
                        drawHeight = canvas.height;
                        drawWidth = drawHeight * imgRatio;
                        offsetX = (canvas.width - drawWidth) / 2;
                        offsetY = 0;
                    } else { // –ó–∞–ø–æ–ª–Ω–∏—Ç—å –ø–æ —à–∏—Ä–∏–Ω–µ
                        drawWidth = canvas.width;
                        drawHeight = drawWidth / imgRatio;
                        offsetX = 0;
                        offsetY = (canvas.height - drawHeight) / 2;
                    }
                    
                    ctx.drawImage(bgImg, offsetX, offsetY, drawWidth, drawHeight);
                } else {
                    ctx.fillStyle = '#f0f8ff'; // –ï—Å–ª–∏ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–≤–µ—Ç–ª–æ-–≥–æ–ª—É–±–æ–π
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                }
            } else {
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }

            // 2. –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –≠–ª–µ–º–µ–Ω—Ç–æ–≤ (–°—Ç–∏–∫–µ—Ä—ã, –õ–æ–≥–æ, –¢–µ–∫—Å—Ç)
            state.draggableItems.forEach((item, index) => {
                if (item.type === 'sticker' || item.type === 'logo') {
                    const img = cachedImages.get(item.src);
                    if (img) {
                        ctx.drawImage(img, item.x, item.y, item.width, item.height);
                    }
                } else if (item.type === 'text') {
                    renderText(item);
                }

                // –†–∏—Å—É–µ–º —Ä–∞–º–∫—É –≤—ã–±–æ—Ä–∞ –∏ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ —Ç–æ—á–∫–∏ —Ç–æ–ª—å–∫–æ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞
                if (index === selectedElementIndex) {
                    drawSelectionBox(item);
                }
            });
        }

        function drawSelectionBox(item) {
            ctx.strokeStyle = '#014d77';
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]); // –ü—É–Ω–∫—Ç–∏—Ä
            
            let boxX, boxY, boxWidth, boxHeight;

            if (item.type === 'sticker' || item.type === 'logo') {
                boxX = item.x;
                boxY = item.y;
                boxWidth = item.width;
                boxHeight = item.height;
            } else if (item.type === 'text') {
                // –î–ª—è —Ç–µ–∫—Å—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º –≥—Ä–∞–Ω–∏—Ü—ã —Ç–µ–∫—Å—Ç–∞
                boxWidth = item.width;
                boxHeight = item.height; 
                boxX = item.align === 'center' ? item.x - boxWidth / 2 : item.x;
                boxY = item.y - boxHeight / 2;
            } else {
                return;
            }

            ctx.strokeRect(boxX, boxY, boxWidth, boxHeight);
            ctx.setLineDash([]); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—É–Ω–∫—Ç–∏—Ä

            // –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è —Ç–æ—á–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è —Å—Ç–∏–∫–µ—Ä–æ–≤/–ª–æ–≥–æ)
            if (item.type === 'sticker' || item.type === 'logo') {
                const handleSize = 12;
                ctx.fillStyle = '#014d77';
                ctx.fillRect(boxX + boxWidth - handleSize / 2, boxY + boxHeight - handleSize / 2, handleSize, handleSize);
            }
        }

        function getFontSize(size) {
            switch(size) {
                case 'small': return Math.min(canvas.width, canvas.height) * 0.04;
                case 'large': return Math.min(canvas.width, canvas.height) * 0.07;
                default: return Math.min(canvas.width, canvas.height) * 0.05;
            }
        }

        function renderText(item) {
            if (!item.content) return;

            ctx.fillStyle = item.color;
            
            let fontFamily;
            switch(item.font) {
                case 'Marck Script': fontFamily = "'Marck Script', cursive"; break;
                case 'Caveat': fontFamily = "'Caveat', cursive"; break;
                case 'Bad Script': fontFamily = "'Bad Script', cursive"; break;
                default: fontFamily = "'Marck Script', cursive";
            }
            
            const fontSize = getFontSize(item.size);
            const lineHeight = fontSize * 1.3;
            const maxWidth = item.width; // –ò—Å–ø–æ–ª—å–∑—É–µ–º —à–∏—Ä–∏–Ω—É —ç–ª–µ–º–µ–Ω—Ç–∞
            
            ctx.textAlign = item.align;
            ctx.textBaseline = 'middle';
            
            const lines = wrapText(ctx, item.content, maxWidth, fontSize, fontFamily);

            // –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã—Å–æ—Ç—É —ç–ª–µ–º–µ–Ω—Ç–∞ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è –∏ —Ä–∞–º–∫–∏
            item.height = lines.length * lineHeight;
            
            let xPos = item.x; // x - —ç—Ç–æ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–∞
            if (item.align === 'left') xPos = item.x - item.width / 2 + (canvas.width * 0.02); // –ù–µ–±–æ–ª—å—à–æ–π –æ—Ç—Å—Ç—É–ø
            if (item.align === 'right') xPos = item.x + item.width / 2 - (canvas.width * 0.02);

            let startY = item.y - (item.height / 2) + (lineHeight / 2);

            lines.forEach((line, index) => {
                if (line.text.trim()) {
                    ctx.font = `bold ${fontSize}px ${fontFamily}`;
                    ctx.fillText(line.text, xPos, startY + index * lineHeight);
                }
            });
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞ —Ç–µ–∫—Å—Ç–∞
        function wrapText(context, text, maxWidth, fontSize, fontFamily) {
            const paragraphs = text.split('\n');
            const lines = [];
            
            context.font = `bold ${fontSize}px ${fontFamily}`;

            for (const paragraph of paragraphs) {
                const words = paragraph.split(' ');
                let currentLine = '';

                for (let i = 0; i < words.length; i++) {
                    const testLine = currentLine ? currentLine + ' ' + words[i] : words[i];
                    const metrics = context.measureText(testLine);
                    
                    if (metrics.width > maxWidth && currentLine !== '') {
                        lines.push({ text: currentLine, fontSize: fontSize });
                        currentLine = words[i];
                    } else {
                        currentLine = testLine;
                    }
                }
                if (currentLine) {
                    lines.push({ text: currentLine, fontSize: fontSize });
                }
            }
            return lines;
        }

        // --- –î–ï–ô–°–¢–í–ò–Ø ---

        function downloadCard() {
            // –î–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ–º —É–≤–µ–ª–∏—á–µ–Ω–Ω–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ (2x) –¥–ª—è "HD"
            const scaleFactor = 2;
            const hdCanvas = document.createElement('canvas');
            hdCanvas.width = canvas.width * scaleFactor;
            hdCanvas.height = canvas.height * scaleFactor;
            const hdCtx = hdCanvas.getContext('2d');
            
            // –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º –≤—Å—é –æ—Ç—Ä–∏—Å–æ–≤–∫—É
            hdCtx.scale(scaleFactor, scaleFactor);
            
            // –í—ã–ø–æ–ª–Ω—è–µ–º –æ—Ç—Ä–∏—Å–æ–≤–∫—É —Å —É—á–µ—Ç–æ–º –º–∞—Å—à—Ç–∞–±–∞
            renderCardHD(hdCtx, hdCanvas.width / scaleFactor, hdCanvas.height / scaleFactor);

            // –°–∫–∞—á–∏–≤–∞–µ–º
            const dataURL = hdCanvas.toDataURL('image/png');
            const link = document.createElement('a');
            link.href = dataURL;
            link.download = 'novogodnyaya-otkrytka.png';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –º–∞—Å—à—Ç–∞–± –Ω–∞ –æ–±—ã—á–Ω—ã–π canvas
            ctx.scale(1 / scaleFactor, 1 / scaleFactor);
        }

        // –§—É–Ω–∫—Ü–∏—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –¥–ª—è HD (–ø–æ—á—Ç–∏ –∏–¥–µ–Ω—Ç–∏—á–Ω–∞ renderCard, –Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –¥—Ä—É–≥–æ–π –∫–æ–Ω—Ç–µ–∫—Å—Ç)
        function renderCardHD(hdCtx, hdWidth, hdHeight) {
            // 1. –§–æ–Ω
            if (state.selectedBackground) {
                const bgImg = cachedImages.get(state.selectedBackground);
                if (bgImg) {
                    const imgRatio = bgImg.width / bgImg.height;
                    const canvasRatio = hdWidth / hdHeight;
                    
                    let drawWidth, drawHeight, offsetX, offsetY;
                    
                    if (imgRatio > canvasRatio) { 
                        drawHeight = hdHeight;
                        drawWidth = drawHeight * imgRatio;
                        offsetX = (hdWidth - drawWidth) / 2;
                        offsetY = 0;
                    } else { 
                        drawWidth = hdWidth;
                        drawHeight = drawWidth / imgRatio;
                        offsetX = 0;
                        offsetY = (hdHeight - drawHeight) / 2;
                    }
                    
                    hdCtx.drawImage(bgImg, offsetX, offsetY, drawWidth, drawHeight);
                } else {
                    hdCtx.fillStyle = '#f0f8ff';
                    hdCtx.fillRect(0, 0, hdWidth, hdHeight);
                }
            }
            
            // 2. –≠–ª–µ–º–µ–Ω—Ç—ã
            state.draggableItems.forEach(item => {
                 if (item.type === 'sticker' || item.type === 'logo') {
                    const img = cachedImages.get(item.src);
                    if (img) {
                        hdCtx.drawImage(img, item.x, item.y, item.width, item.height);
                    }
                } else if (item.type === 'text') {
                    renderTextHD(hdCtx, item, hdWidth, hdHeight);
                }
            });
        }
        
        // –û—Ç–¥–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ —Ç–µ–∫—Å—Ç–∞ –≤ HD, —á—Ç–æ–±—ã –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å —Ä–∞–∑–º–µ—Ä
        function renderTextHD(hdCtx, item, hdWidth, hdHeight) {
             if (!item.content) return;

            hdCtx.fillStyle = item.color;
            
            let fontFamily;
            switch(item.font) {
                case 'Marck Script': fontFamily = "'Marck Script', cursive"; break;
                case 'Caveat': fontFamily = "'Caveat', cursive"; break;
                case 'Bad Script': fontFamily = "'Bad Script', cursive"; break;
                default: fontFamily = "'Marck Script', cursive";
            }
            
            // –†–∞—Å—á–µ—Ç —Ä–∞–∑–º–µ—Ä–∞ —à—Ä–∏—Ñ—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ HD-—Ä–∞–∑–º–µ—Ä–æ–≤
            function getFontSizeHD(size) {
                 switch(size) {
                    case 'small': return Math.min(hdWidth, hdHeight) * 0.04;
                    case 'large': return Math.min(hdWidth, hdHeight) * 0.07;
                    default: return Math.min(hdWidth, hdHeight) * 0.05;
                }
            }
            
            const fontSize = getFontSizeHD(item.size);
            const lineHeight = fontSize * 1.3;
            const maxWidth = item.width; 
            
            hdCtx.textAlign = item.align;
            hdCtx.textBaseline = 'middle';
            
            const lines = wrapText(hdCtx, item.content, maxWidth, fontSize, fontFamily);
            
            let xPos = item.x; 
            if (item.align === 'left') xPos = item.x - item.width / 2 + (hdWidth * 0.02); 
            if (item.align === 'right') xPos = item.x + item.width / 2 - (hdWidth * 0.02);

            let startY = item.y - (item.height / 2) + (lineHeight / 2);

            lines.forEach((line, index) => {
                if (line.text.trim()) {
                    hdCtx.font = `bold ${fontSize}px ${fontFamily}`;
                    hdCtx.fillText(line.text, xPos, startY + index * lineHeight);
                }
            });
        }


        function clearCard() {
            const initialText = state.greetingText;
            
            // –°–±—Ä–æ—Å –≤—Å–µ—Ö —Å—Ç–∏–∫–µ—Ä–æ–≤ –∏ –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç –∏ –ª–æ–≥–æ—Ç–∏–ø
            state.draggableItems = state.draggableItems.filter(item => item.type === 'text' || item.type === 'logo');

            // –°–±—Ä–æ—Å —Ç–µ–∫—Å—Ç–∞ –∫ –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ–º—É
            state.greetingText = '–° –ù–æ–≤—ã–º –ì–æ–¥–æ–º!';
            greetingTextInput.value = state.greetingText;

            // –°–±—Ä–æ—Å –≤—ã–±–æ—Ä–∞
            selectedElementIndex = -1;
            
            // –°–±—Ä–æ—Å —Å—Ç–∏–ª–µ–π —Ç–µ–∫—Å—Ç–∞ –∫ –∞–∫—Ç–∏–≤–Ω—ã–º –≤ UI
            const textItem = state.draggableItems.find(item => item.type === 'text');
            if (textItem) {
                 textItem.content = state.greetingText;
                 textItem.font = state.textFont;
                 textItem.size = state.textSize;
                 textItem.align = state.textAlign;
                 textItem.color = state.textColor;
            }

            // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞
            renderCard();
        }
    </script>
</body>
</html>
